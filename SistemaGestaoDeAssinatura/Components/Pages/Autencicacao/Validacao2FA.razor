@page "/validar-2fa"
@layout LoginLayout
@attribute [Authorize]
@inject HttpClient Http
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime

<PageTitle>Validar 2FA</PageTitle>

<RadzenCard Style="max-width: 400px; margin: 50px auto;">
    <RadzenStack Gap="1.5rem">
        <RadzenText TextStyle="TextStyle.H3" Align="TextAlign.Center">Validar Código 2FA</RadzenText>
        <RadzenText Align="TextAlign.Center" Style="color: #666;">Digite o código do seu aplicativo autenticador</RadzenText>
        
        <EditForm Model="@validacao2FA" OnValidSubmit="@OnSubmit">
            <RadzenFieldset Text="Código de Autenticação">
                <RadzenStack Gap="1rem">
                    <RadzenFormField Text="Código" class="rz-col-12">
                        <RadzenTextBox @bind-Value="@validacao2FA.Codigo" 
                                       Placeholder="Digite o código de 6 dígitos" 
                                       MaxLength="6" style="width: 100%" />
                    </RadzenFormField>

@*                     <RadzenFormField Text="Usuário" class="rz-col-12">
                        <RadzenTextBox @bind-Value="@validacao2FA.Username" 
                                       Placeholder="Digite seu usuário" 
                                       style="width: 100%" />
                    </RadzenFormField> *@

                    @if (!string.IsNullOrEmpty(mensagemErro))
                    {
                        <RadzenAlert AlertStyle="AlertStyle.Danger" Title="Erro" Text="@mensagemErro" />
                    }

                    <RadzenButton ButtonType="ButtonType.Submit" ButtonStyle="ButtonStyle.Primary" 
                                  Text="Validar" Icon="verified" class="rz-col-12" IsBusy="@carregando" />
                </RadzenStack>
            </RadzenFieldset>
        </EditForm>
    </RadzenStack>
</RadzenCard>

@code {
    private Validacao2FADTO validacao2FA = new();
    private string mensagemErro = string.Empty;
    private bool carregando = false;

    private async Task OnSubmit()
    {
        if (string.IsNullOrEmpty(validacao2FA.Codigo))
        {
            mensagemErro = "Por favor, preencha todos os campos";
            return;
        }

        carregando = true;
        mensagemErro = string.Empty;

        try
        {
            var response = await Http.PostAsJsonAsync("api/Account/Validar2FA", validacao2FA);
            if (response.IsSuccessStatusCode)
            {
                var resultado = await response.Content.ReadFromJsonAsync<RespostaDTO<DadosLogin>>();
                if (resultado != null && resultado.Sucesso)
                {
                    // Recarregar a página para aplicar autenticação completa
                    Navigation.NavigateTo("/usuarios", forceLoad: true);
                }
                else
                {
                    mensagemErro = resultado?.Mensagem ?? "Código inválido";
                }
            }
            else
            {
                mensagemErro = $"Erro: {response.RequestMessage}";
            }

        }
        catch (Exception ex)
        {
            mensagemErro = $"Erro: {ex.Message}";
        }
        finally
        {
            carregando = false;
        }
    }
}

